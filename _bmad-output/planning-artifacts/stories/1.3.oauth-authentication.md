# Story 1.3: OAuth Authentication (Google & Facebook)

## Status: Draft

## Dependencies

- **Requires:** [Story 1.1 - Project Setup & Landing Page](1.1.project-setup-landing-page.md) completed
- **Requires:** [Story 1.2 - Email/Password Authentication](1.2.email-password-authentication.md) completed (Breeze installed)

## Story

**As a** new user,
**I want** to register/login with my Google or Facebook account,
**so that** I can sign up quickly without creating a new password.

## Acceptance Criteria

1. Laravel Socialite installed and configured
2. Google OAuth integration functional (client ID/secret configured)
3. Facebook OAuth integration functional (app ID/secret configured)
4. OAuth buttons displayed on login/registration pages
5. New users via OAuth create account automatically
6. Existing users via OAuth log in to existing account (matched by email)
7. OAuth errors handled gracefully with user-friendly French messages
8. User's OAuth provider stored for future reference

## Tasks / Subtasks

- [ ] Task 1: Install Laravel Socialite (AC: 1)
  - [ ] Run `composer require laravel/socialite`

- [ ] Task 2: Configure Google OAuth (AC: 2)
  - [ ] Add Google credentials to `.env`
  - [ ] Configure `config/services.php` for Google

- [ ] Task 3: Configure Facebook OAuth (AC: 3)
  - [ ] Add Facebook credentials to `.env`
  - [ ] Configure `config/services.php` for Facebook

- [ ] Task 4: Create SocialiteController (AC: 5, 6, 8)
  - [ ] Create `app/Http/Controllers/Auth/SocialiteController.php`
  - [ ] Implement `redirectToProvider($provider)` method
  - [ ] Implement `handleProviderCallback($provider)` method
  - [ ] Handle new user creation with Player
  - [ ] Handle existing user login (match by email)
  - [ ] Store `oauth_provider` and `oauth_id` in User model

- [ ] Task 5: Add OAuth Routes
  - [ ] Add `GET /auth/{provider}` route
  - [ ] Add `GET /auth/{provider}/callback` route

- [ ] Task 6: Update Login/Register UI (AC: 4)
  - [ ] Add Google OAuth button to login page
  - [ ] Add Facebook OAuth button to login page
  - [ ] Add OAuth buttons to register page

- [ ] Task 7: Error Handling (AC: 7)
  - [ ] Handle OAuth cancellation by user
  - [ ] Handle OAuth provider errors
  - [ ] Display French error messages

## Dev Notes

### Relevant Architecture References

> See: [docs/architecture.md](../architecture.md) Section 6.1 (Authentication Component)
> See: [docs/architecture.md](../architecture.md) Section 10.4 (Authentication Flow)
> See: [docs/guides/oauth-setup-guide.md](../guides/oauth-setup-guide.md) for Google/Facebook console setup

**Environment Variables (.env) - OAuth Credentials:**
```env
# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI="${APP_URL}/auth/google/callback"

# Facebook OAuth
FACEBOOK_CLIENT_ID=your-facebook-app-id
FACEBOOK_CLIENT_SECRET=your-facebook-app-secret
FACEBOOK_REDIRECT_URI="${APP_URL}/auth/facebook/callback"
```

**OAuth Configuration:**
```php
// config/services.php
'google' => [
    'client_id' => env('GOOGLE_CLIENT_ID'),
    'client_secret' => env('GOOGLE_CLIENT_SECRET'),
    'redirect' => env('GOOGLE_REDIRECT_URI'),
],
'facebook' => [
    'client_id' => env('FACEBOOK_CLIENT_ID'),
    'client_secret' => env('FACEBOOK_CLIENT_SECRET'),
    'redirect' => env('FACEBOOK_REDIRECT_URI'),
],
```

**SocialiteController Pattern:**
```php
public function handleProviderCallback(string $provider)
{
    $socialUser = Socialite::driver($provider)->user();
    $user = User::where('email', $socialUser->getEmail())->first();

    if (!$user) {
        $user = User::create([
            'email' => $socialUser->getEmail(),
            'oauth_provider' => $provider,
            'oauth_id' => $socialUser->getId(),
            'email_verified_at' => now(),
        ]);
        app(PlayerService::class)->createForUser($user);
    }

    Auth::login($user, true);
    return redirect()->route('profile.edit');
}
```

### Edge Cases & Business Rules

**Email Already Exists (AC: 6):**
When a user authenticates via OAuth with an email that already exists in the database:
1. **Link the OAuth account** to the existing user record
2. Update `oauth_provider` and `oauth_id` fields
3. Log the user in (do NOT create a duplicate account)
4. User retains ability to login via email/password AND OAuth

**OAuth-Only Users:**
- Users who register via OAuth have `password = null`
- They cannot use "Forgot Password" flow (no password to reset)
- Future: Story 1.4 should allow adding a password to OAuth-only accounts

**OAuth Button Design:**
- Google button: White background, Google logo, "Continuer avec Google"
- Facebook button: Facebook blue (#1877F2), Facebook logo, "Continuer avec Facebook"

### Testing

**Test Location:** `tests/Feature/Auth/OAuthTest.php`

**Test Scenarios:**
```php
// Mock Socialite for testing
public function test_new_user_can_register_via_google(): void
{
    $this->mockSocialiteUser('google', 'test@example.com');

    $response = $this->get('/auth/google/callback');

    $this->assertAuthenticated();
    $this->assertDatabaseHas('users', [
        'email' => 'test@example.com',
        'oauth_provider' => 'google',
    ]);
    $this->assertDatabaseHas('players', [
        'user_id' => User::first()->id,
    ]);
}

public function test_existing_user_can_login_via_oauth(): void
{
    $user = User::factory()->create(['email' => 'existing@example.com']);
    $this->mockSocialiteUser('google', 'existing@example.com');

    $response = $this->get('/auth/google/callback');

    $this->assertAuthenticatedAs($user);
    // User count should still be 1 (no duplicate)
    $this->assertCount(1, User::all());
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.1 | Added dependencies, .env config, edge cases, test examples | Bob (SM) |
| 2026-01-08 | 1.0 | Initial story creation from PRD | Sarah (PO) |
