# Story 1.4: Account Settings & GDPR Compliance

## Status: Draft

## Dependencies

- **Requires:** [Story 1.1 - Project Setup & Landing Page](1.1.project-setup-landing-page.md) completed
- **Requires:** [Story 1.2 - Email/Password Authentication](1.2.email-password-authentication.md) completed
- **Requires:** [Story 1.3 - OAuth Authentication](1.3.oauth-authentication.md) completed

## Story

**As a** registered user,
**I want** to manage my account settings and delete my account,
**so that** I have control over my data per GDPR requirements.

## Acceptance Criteria

1. Account settings page accessible to authenticated users
2. User can update email address (with re-verification)
3. User can change password (requires current password)
4. User can request account deletion with confirmation modal
5. Account deletion removes all user data (soft delete with 30-day grace period, then hard delete)
6. GDPR consent checkbox on registration form
7. Privacy policy and terms of service pages exist (placeholder content)
8. User can export their data (JSON format) - basic implementation

## Tasks / Subtasks

- [ ] Task 1: Create Settings Controller & Routes (AC: 1)
  - [ ] Create `app/Http/Controllers/SettingsController.php`
  - [ ] Add routes under auth middleware
  - [ ] Create `resources/views/pages/settings/index.blade.php`

- [ ] Task 2: Email Update Functionality (AC: 2)
  - [ ] Add email update form
  - [ ] Implement email change with verification
  - [ ] Reset `email_verified_at` on change

- [ ] Task 3: Password Change Functionality (AC: 3)
  - [ ] Add password change form
  - [ ] Require current password verification
  - [ ] Handle OAuth-only users (see Edge Cases below)

- [ ] Task 4: Account Deletion (AC: 4, 5)
  - [ ] Add delete account section with confirmation modal
  - [ ] Implement soft delete on User model
  - [ ] Create scheduled command for 30-day hard delete

- [ ] Task 5: GDPR Consent (AC: 6)
  - [ ] Add consent checkbox to registration form
  - [ ] Add `gdpr_consented_at` column to users table

- [ ] Task 6: Legal Pages (AC: 7)
  - [ ] Create privacy policy page
  - [ ] Create terms of service page

- [ ] Task 7: Data Export (AC: 8)
  - [ ] Create export functionality
  - [ ] Return JSON file with all user data

## Dev Notes

### Relevant Architecture References

> See: [docs/architecture.md](../architecture.md) Section 5.1 (API Routes - Settings)
> See: [docs/architecture.md](../architecture.md) Section 7.3 (Core Workflows)
> See: [docs/front-end-spec.md](../front-end-spec.md) Section 3.2.7 (Account Settings)
> See: [docs/ai-ui-prompts.md](../ai-ui-prompts.md) Prompt 6 (Account Settings UI)

**Settings Routes:**
```php
Route::prefix('settings')->name('settings.')->group(function () {
    Route::get('/', [SettingsController::class, 'index'])->name('index');
    Route::put('/email', [SettingsController::class, 'updateEmail'])->name('email');
    Route::put('/password', [SettingsController::class, 'updatePassword'])->name('password');
    Route::get('/export', [SettingsController::class, 'export'])->name('export');
    Route::delete('/account', [SettingsController::class, 'destroy'])->name('destroy');
});
```

**User Model with Soft Deletes:**
```php
use Illuminate\Database\Eloquent\SoftDeletes;

class User extends Authenticatable
{
    use SoftDeletes;
}
```

**Scheduled Command for Hard Delete (30 days):**
```php
// app/Console/Commands/PurgeDeletedUsers.php
class PurgeDeletedUsers extends Command
{
    protected $signature = 'users:purge';
    protected $description = 'Permanently delete users soft-deleted more than 30 days ago';

    public function handle(): void
    {
        $count = User::onlyTrashed()
            ->where('deleted_at', '<', now()->subDays(30))
            ->each(function ($user) {
                // Delete associated Player and all related data
                $user->player?->delete();
                $user->forceDelete();
            });

        $this->info("Purged {$count} users.");
    }
}

// Schedule in app/Console/Kernel.php or routes/console.php
Schedule::command('users:purge')->daily();
```

**Data Export JSON Structure:**
```json
{
  "user": {
    "email": "user@example.com",
    "created_at": "2026-01-08T10:00:00Z"
  },
  "player": {
    "first_name": "Jean",
    "last_name": "Dupont",
    "nickname": "JD",
    "city": "Paris",
    "skill_level": "amateur"
  },
  "club": {
    "name": "Darts Club Paris",
    "federation": "FFD"
  },
  "equipment": {
    "components": [...],
    "assemblies": [...]
  },
  "exported_at": "2026-01-08T12:00:00Z"
}
```

### Edge Cases & Business Rules

**OAuth-Only Users (password = null):**
- Email change: **Allowed** — works normally, sends verification email
- Password change: **Show "Add Password" form** instead of "Change Password"
  - User can SET a new password (no current password required)
  - After setting, user can login via email/password AND OAuth
- Account deletion: **Allowed** — works normally

**Email Change for OAuth Users:**
- If user changes email to one different from their OAuth provider email:
  - OAuth login will still work (matched by `oauth_id`, not email)
  - User can login via new email + password (if set)

**Account Deletion Cascade:**
- Soft delete `User` → Player remains but is hidden from public
- After 30 days hard delete:
  - Delete `Player` and all related records
  - Delete uploaded files (photos, MP3s)
  - Remove from all `DartAssembly` records

**UI Structure (from Prompt 6):**
```
Settings Page Layout:
├── Sidebar Navigation (desktop) / Tabs (mobile)
│   ├── Compte (active)
│   ├── Confidentialité
│   ├── Notifications
│   └── Zone danger
├── Section: Compte
│   ├── Card: Email (edit inline)
│   ├── Card: Mot de passe (change/add form)
│   └── Card: Méthode de connexion (OAuth status)
├── Section: Confidentialité (toggles)
└── Section: Zone danger (red cards)
    ├── Désactiver mon compte
    ├── Supprimer mon compte (confirmation modal)
    └── Exporter mes données (GDPR)
```

### Testing

**Test Location:** `tests/Feature/Settings/`

**Test Scenarios:**
```php
public function test_user_can_update_email(): void
{
    $user = User::factory()->create(['email' => 'old@example.com']);

    $response = $this->actingAs($user)
        ->put('/settings/email', ['email' => 'new@example.com']);

    $response->assertRedirect();
    $this->assertDatabaseHas('users', [
        'id' => $user->id,
        'email' => 'new@example.com',
        'email_verified_at' => null, // Reset verification
    ]);
}

public function test_oauth_user_can_add_password(): void
{
    $user = User::factory()->create([
        'password' => null,
        'oauth_provider' => 'google',
    ]);

    $response = $this->actingAs($user)
        ->put('/settings/password', [
            'password' => 'newpassword123',
            'password_confirmation' => 'newpassword123',
        ]);

    $response->assertRedirect();
    $this->assertNotNull($user->fresh()->password);
}

public function test_account_deletion_soft_deletes_user(): void
{
    $user = User::factory()->create();

    $response = $this->actingAs($user)
        ->delete('/settings/account', [
            'confirmation' => 'SUPPRIMER',
        ]);

    $this->assertSoftDeleted('users', ['id' => $user->id]);
    $this->assertGuest();
}

public function test_purge_command_hard_deletes_old_users(): void
{
    $oldUser = User::factory()->create();
    $oldUser->delete();
    $oldUser->update(['deleted_at' => now()->subDays(31)]);

    $this->artisan('users:purge');

    $this->assertDatabaseMissing('users', ['id' => $oldUser->id]);
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.1 | Added dependencies, refs, edge cases, scheduled command, JSON export, tests | Bob (SM) |
| 2026-01-08 | 1.0 | Initial story creation from PRD | Sarah (PO) |
